<html>
<head>
  <title>Evernote Export</title>
  <basefont face="Tahoma" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/303788 (en-US, DDL); Windows/6.1.7601 Service Pack 1 (Win64);"/>
  <style>
    body, td {
      font-family: Tahoma;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="432"/>

<div>
<span><div>学习caffe的目的，不是简单地做几个练习，最终还是要用到自己实际的项目或科研中。因此，本文介绍一下，从自己的原始图片到lmdb数据，再到训练和测试模型的整个流程。</div><div><br/></div><div><b>一、准备数据</b></div><div><br/></div><div>有条件的同学，可以去imagenet的官网http://www.image-net.org/download-images，下载imagenet图片来训练。但是我没有下载，一个原因是注册账号的时候，验证码始终出不来(听说是google网站的验证码，而我是上不了google的)。第二个原因是数据太大了。</div><div><br/></div><div>在网上找了一些其他的图片来代替，共有500张图片，分为大巴车、恐龙、大象、鲜花、马五个类，每个类100张。需要的同学可以去网盘下载：http://pan.baidu.com/s/1nuqlTnN</div><div><br/></div><div>编号分别以3、4、5、6、7开头，各位一类。从其中每类选出20张作为测试，其余80张作为训练。因此最终训练图片400张，测试图片100张，共5类。将图片放在根目录下的data文件夹下面。即训练图片目录：data/re/train/，测试图片目录：data/re/test/。</div><div><br/></div><div><b>二、转换为lmdb格式</b></div><div><br/></div><div>具体的转换过程参见上一篇文章。</div><div><br/></div><div>首先，在examples下面创建一个myfile的文件夹，用来存放配置文件和脚本文件。然后编写一个脚本create_filelist.sh，用来生成train.txt和test.txt清单文件：</div><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div># sudo mkdir examples/myfile</div><div># sudo vim examples/myfile/create_filelist.sh</div></div><div><br/></div><div>编辑此文件，写入：</div><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>#!/usr/bin/env sh</div><div>DATA=data/re/</div><div>MY=examples/myfile</div><div><br/></div><div>echo &quot;Create train.txt ...&quot;</div><div>rm -rf $MY/train.txt</div><div>for i in 3 4 5 6 7</div><div>do</div><div>find $DATA/train -name $i*.jpg | cut -d '/' -f4-5 | sed &quot;s/$/ $i/&quot;&gt;&gt;$MY/train.txt</div><div>done</div><div>echo &quot;Create test.txt ...&quot;</div><div>rm -rf $MY/test.txt</div><div>for i in 3 4 5 6 7</div><div>do</div><div>find $DATA/test -name $i*.jpg | cut -d '/' -f4-5 | sed &quot;s/$/ $i/&quot;&gt;&gt;$MY/test.txt</div><div>done</div><div>echo &quot;All done.&quot;</div></div><div><br/></div><div>然后运行此脚本</div><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div># sudo sh examples/myfile/create_filelist.sh</div></div><div><br/></div><div>成功的话，就会在examples/myfile/文件夹下生成train.txt和test.txt两个文本文件，里面就是图片的列表清单。</div><div><br/></div><div>                                                  <img src="11.训练和测试自己的图片_files/train_list.png" type="image/png" style="height: auto;"/></div><div><br/></div><div>接着再编写一个脚本文件，调用convert_imageset命令来转换数据格式。</div><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div># sudo vim examples/myfile/create_lmdb.sh</div></div><div><br/></div><div>插入：</div><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>#!/usr/bin/env sh</div><div>DATA=data/re</div><div>MY=examples/myfile</div><div><br/></div><div>echo &quot;Create train lmdb ...&quot;</div><div>rm -rf $MY/img_train_lmdb</div><div>build/tools/convert_imageset \</div><div>--shuffle \</div><div>--resize_height=256 \</div><div>--resize_width=256 \</div><div>/home/xxx/caffe-master/data/re/train/ \</div><div>$MY/train.txt \</div><div>$MY/img_train_lmdb</div><div><br/></div><div>echo &quot;Create test lmdb ...&quot;</div><div>rm -rf $MY/img_test_lmdb</div><div>build/tools/convert_imageset \</div><div>--shuffle \</div><div>--resize_width=256 \</div><div>--resize_height=256 \</div><div>/home/xxx/caffe-master/data/re/test/ \</div><div>$MY/test.txt \</div><div>$MY/img_test_lmdb</div><div><br/></div><div>echo &quot;All done.&quot;</div></div><div><br/></div><div>因为图片大小不一，因此统一转换成256*256大小。运行成功后，会在examples/myfile下面生成两个文件夹img_train_lmdb和img_test_lmdb，分别用于保存图片转换后的lmdb文件。</div><div><br/></div><div><b>三、计算均值并保存</b></div><div><br/></div><div>图片减去均值再训练，会提高训练速度和精度。因此，一般都会有这个操作。</div><div><br/></div><div>caffe程序提供了一个计算均值的文件compute_image_mean.cpp，我们直接使用就可以了。</div><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div># sudo build/tools/compute_image_mean examples/myfile/img_train_lmdb examples/myfile/mean.binaryproto</div></div><div><br/></div><div>compute_image_mean带两个参数，第一个参数是lmdb训练数据位置，第二个参数设定均值文件的名字保存路径。</div><div><br/></div><div>运行成功后，会在examples/myfile/下面生成一个mean.binaryproto的均值文件。</div><div><br/></div><div><b>四、创建模型并编写配置文件</b></div><div><br/></div><div>模型就用程序自带的caffenet模型，位置在models/bvlc_reference_caffenet/文件夹下，将需要的两个配置文件，复制到myfile文件夹内：</div><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div># sudo cp models/bvlc_reference_caffenet/solver.prototxt examples/myfile/</div><div># sudo cp models/bvlc_reference_caffenet/train_val.prototxt examples/myfile/</div></div><div><br/></div><div>修改其中的solver.prototxt：</div><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div># sudo vim examples/myfile/solver.prototxt</div></div><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>net: &quot;examples/myfile/train_val.prototxt&quot;</div><div>test_iter: 2</div><div>test_interval: 50</div><div>base_lr: 0.001</div><div>lr_policy: &quot;step&quot;</div><div>gamma: 0.1</div><div>stepsize: 100</div><div>display: 20</div><div>max_iter: 500</div><div>momentum: 0.9</div><div>weight_decay: 0.005</div><div>solver_mode: CPU</div></div><div><br/></div><div>100个测试数据，batch_size为50，因此test_iter设置为2，就能全cover了。在训练过程中，调整学习率，逐步变小。</div><div><br/></div><div>修改train_val.prototxt，只需要修改两个阶段的data层就可以了，其他可以不用管。</div><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>name: &quot;CaffeNet&quot;</div><div>layer {</div><div>     name: &quot;data&quot;</div><div>     type: &quot;Data&quot;</div><div>     top: &quot;data&quot;</div><div>     top: &quot;label&quot;</div><div>     include {</div><div>          phase: TRAIN</div><div>     }</div><div>     transform_param {</div><div>          mirror: true</div><div>          crop_size: 227</div><div>          mean_file: &quot;examples/myfile/mean.binaryproto&quot;</div><div>     }</div><div>     data_param {</div><div>          source: &quot;examples/myfile/img_train_lmdb&quot;</div><div>          batch_size: 256</div><div>          backend: LMDB</div><div>     }</div><div>}</div><div>layer {</div><div>     name: &quot;data&quot;</div><div>     type: &quot;Data&quot;</div><div>     top: &quot;data&quot;</div><div>     top: &quot;label&quot;</div><div>     include {</div><div>          phase: TEST</div><div>     }</div><div>     transform_param {</div><div>          mirror: false</div><div>          crop_size: 227</div><div>          mean_file: &quot;examples/myfile/mean.binaryproto&quot;</div><div>     }</div><div>     data_param {</div><div>          source: &quot;examples/myfile/img_test_lmdb&quot;</div><div>          batch_size: 50</div><div>          backend: LMDB</div><div>     }</div><div>}</div></div><div><br/></div><div>实际上就是修改两个data layer的mean_file和source这两个地方，其他都没有变化。</div><div><br/></div><div><b>五、训练和测试</b></div><div><br/></div><div>如果前面没有问题，数据准备好了，配置文件也配置好了，这一步就比较简单了：</div><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div># sudo build/tools/caffe train -solver examples/myfile/solver.prototxt</div></div><div><br/></div><div>运行时间和最后的精确度，会根据机器配置，参数设置的不同而不同。这里实在GPU+cudnn下运行500次，大约8分钟，精度95%。</div><div><br/></div><div><img src="11.训练和测试自己的图片_files/result-part.png" type="image/png"/></div></span>
</div></body></html> 