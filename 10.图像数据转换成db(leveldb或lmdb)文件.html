<html>
<head>
  <title>Evernote Export</title>
  <basefont face="Tahoma" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/303788 (en-US, DDL); Windows/6.1.7601 Service Pack 1 (Win64);"/>
  <style>
    body, td {
      font-family: Tahoma;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="430"/>

<div>
<span><div>在深度学习的实际应用中，我们经常用到的原始数据是图片文件，如jpg、jpeg、png、tif等格式的，而且有可能图片的大小还不一致。而在caffe中经常使用的数据类型是lmdb或leveldb，因此就产生了这样的一个问题：如何将原始图片文件转换成caffe中能够运行的db(leveldb/lmdb)文件？</div><div><br/></div><div>在caffe中，作者为我们提供了这样一个文件：convert_imageset.cpp，存放在根目录下的tools文件夹下。编译之后，生成对应的可执行文件放在build/tools/下面，这个文件的作用就是用于将图片文件转换成caffe框架中能直接使用的db文件。</div><div><br/></div><div>该文件的使用格式：</div><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>convert_imageset [FLAGS] ROOTFOLDER/ LISTFILE DB_NAME</div></div><div><br/></div><div>需要带四个参数：</div><div><br/></div><ul><li>FLAGS：图片参数组，后面详细介绍</li><li>ROOTFOLDER/：图片存放的绝对路径，从linux系统根目录开始</li><li>LISTFILE：图片文件列表清单，一般为一个txt文件，一行一张图片</li><li>DB_NAME：最终生成的db文件存放目录</li></ul><div><br/></div><div>如果图片已经下载到本地电脑上，那么我们首先需要创建一个图片列表清单，保存为txt。</div><div><br/></div><div>本文以caffe程序中自带的图片为例，进行讲解，图片目录是examples/images/，两张图片，一张为cat.jpg，另一张为fish-bike.jpg，表示两个类别。</div><div><br/></div><div>我们创建一个sh脚本文件，调用linux命令来生成图片清单：</div><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div># sudo vi examples/images/create_filelist.sh</div></div><div><br/></div><div>编辑这个文件，输入下面的代码并保存：</div><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>#!/usr/bin/env sh</div><div>DATA=examples/images</div><div>echo &quot;Create train.txt...&quot;</div><div>rm -rf $DATA/train.txt</div><div>find $DATA -name *cat.jpg | cut -d '/' -f3 | sed &quot;s/$/ 1/&quot;&gt;&gt;$DATA/train.txt</div><div>find $DATA -name *bike.jpg | cut -d '/' -f3 | sed &quot;s/$/ 2/&quot;&gt;&gt;$DATA/tmp.txt</div><div>cat $DATA/tmp.txt&gt;&gt;$DATA/train.txt</div><div>rm -rf $DATA/tmp.txt</div><div>echo &quot;Done...&quot;</div></div><div><br/></div><div>这个脚本文件中，用到了rm、find、cut、sed、cat等linux命令。</div><div><br/></div><div style="margin-left:40px;">rm：删除文件</div><div style="margin-left:40px;"><br/></div><div style="margin-left:40px;">find：寻找文件</div><div style="margin-left:40px;"><br/></div><div style="margin-left:40px;">cut：截取路径</div><div style="margin-left:40px;"><br/></div><div style="margin-left:40px;">sed：在每行的最后面加上标注。本例中将找到的*cat.jpg文件加入标注1，找到的*bike.jpg文件加入标注为2</div><div style="margin-left:40px;"><br/></div><div style="margin-left:40px;">cat：本例中用于合并两个类别到一个文件中</div><div><br/></div><div>最终生成如下的一个train.txt文件：</div><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>cat.jpg 1</div><div>fish-bike.jpg 2</div></div><div><br/></div><div>当然，图片很少的时候，手动编写这个列表清单文件就行了。但图片很多的情况下，就需要脚本文件来自动生成了。在以后的实际应用中，还需要生成相应的val.txt和test.txt文件，方法是一样的。</div><div><br/></div><div>生成的这个train.txt文件，就可以作为第三个参数，直接使用了。</div><div><br/></div><div>接下来，我们来了解一下FLAGS这个参数组，有些什么内容：</div><div><br/></div><div style="margin-left:40px;">-gray：是否以灰度图的方式打开图片。程序调用opencv库中的imread()函数来打开图片，默认为false</div><div style="margin-left:40px;"><br/></div><div style="margin-left:40px;">-shuffle：是否随机打乱图片顺序。默认为false</div><div style="margin-left:40px;"><br/></div><div style="margin-left:40px;">-backend：需要转换成的db文件格式，可选为leveldb或lmdb，默认为lmdb</div><div style="margin-left:40px;"><br/></div><div style="margin-left:40px;">-resize_width / -resize_height：改变图片的大小。在运行中，要求所有图片的尺寸一致，因此需要改变图片大小。程序调用opencv库的resize()函数来对图片放大缩小，默认为0，不改变</div><div style="margin-left:40px;"><br/></div><div style="margin-left:40px;">-check_size：检查所有的数据是否有相同的尺寸。默认为false，不检查</div><div style="margin-left:40px;"><br/></div><div style="margin-left:40px;">-encoded：是否将原图片编码放入最终的数据中，默认为false</div><div style="margin-left:40px;"><br/></div><div style="margin-left:40px;">-encoded_type：与前一个参数对应，将图片编码为哪一个格式：'png'、'jpg'……</div><div><br/></div><div>好了，知道这些参数后，我们就可以调用命令来生成最终的lmdb格式数据了。</div><div><br/></div><div>由于参数比较多，因此我们可以编写一个sh脚本来执行命令：</div><div><br/></div><div>首先，创建sh脚本文件：</div><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div># sudo vim examples/images/create_lmdb.sh</div></div><div><br/></div><div>编辑，输入下面的代码并保存：</div><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>#!/usr/bin/env sh</div><div>DATA=examples/images</div><div>rm -rf $DATA/img_train_lmdb</div><div>build/tools/convert_imageset --shuffle \</div><div>--resize_height=256 --resize_width=256 \</div><div>/home/xxx/caffe-master/examples/images/ $DATA/train.txt $DATA/img_train_lmdb</div></div><div><br/></div><div>设置参数-shuffle，打乱图片顺序。设置参数-resize_height和-resize_width将所有图片尺寸都变为256*256。</div><div><br/></div><div>最后运行这个脚本：</div><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div># sudo sh exmaples/images/create_lmdb.sh</div></div><div><br/></div><div>就会在examples/images/目录下生成一个名为img_train_lmdb的文件夹，里面的文件就是我们需要的db文件了。</div></span>
</div></body></html> 