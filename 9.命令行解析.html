<html>
<head>
  <title>Evernote Export</title>
  <basefont face="Tahoma" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/303788 (en-US, DDL); Windows/6.1.7601 Service Pack 1 (Win64);"/>
  <style>
    body, td {
      font-family: Tahoma;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="427"/>

<div>
<span><div>caffe的运行提供三种接口：C++接口(命令行)、Python接口和Matlab接口。本文先对命令行进行解析，后续会依次介绍其他两个接口。</div><div><br/></div><div>caffe的C++主程序(caffe.cpp)放在根目录下的tools文件夹内，当然还有一些其他的功能文件，如：convert_imageset.cpp、train_net.cpp、test_net.cpp等也放在这个文件夹内。经过编译后，这些文件都被编译成了可执行文件，放在./build/tools/文件夹内。因此我们要执行caffe程序，都需要加./build/tools/前缀。</div><div><br/></div><div>如：</div><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div># sudo sh ./build/tools/caffe train -solver=examples/mnist/train_lenet.sh</div></div><div><br/></div><div>caffe程序的命令行执行格式如下：</div><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>caffe &lt;command&gt; &lt;args&gt;</div></div><div><br/></div><div>其中&lt;command&gt;有这样四种：</div><div><br/></div><ul><li>train</li><li>test</li><li>device_query</li><li>time</li></ul><div><br/></div><div>对应的功能为：</div><div><br/></div><ul><li>train——训练或finetune模型(model)</li><li>test——测试模型</li><li>device_query——显示GPU信息</li><li>time——显示程序执行时间</li></ul><div><br/></div><div>其中的&lt;args&gt;参数有：</div><div><br/></div><ul><li>-solver</li><li>-gpu</li><li>-snapshot</li><li>-weights</li><li>-iteration</li><li>-model</li><li>-sighup_effect</li><li>-sigint_effect</li></ul><div><br/></div><div>注意前面有个-符号。对应的功能为：</div><div><br/></div><div>-solver：必选参数。一个protocol buffer类型的文件，即模型的配置文件。如：</div><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div># ./build/tools/caffe train -solver examples/mnist/lenet_solver.prototxt</div></div><div><br/></div><div>-gpu：可选参数。该参数用来指定用哪一块GPU运行，根据GPU的id进行选择，如果设置为--gpu all则使用所有的GPU运行：</div><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div># ./build/tools/caffe train -solver examples/mnist/lenet_solver.prototxt --gpu 2</div></div><div><br/></div><div>-snapshot：可选参数。该参数用来从快照(snapshot)中恢复训练。可以在solver配置文件设置快照，保存solverstate。如：</div><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div># ./build/tools/caffe train -solver examples/mnist/lenet_solver.prototxt -snapshot examples/mnist/lenet_iter_5000.solverstate</div></div><div><br/></div><div>-weights：可选参数。用预先训练好的权重来fine-tuning模型，需要一个caffemodel，不能和-snapshot同时使用。如：</div><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div># ./build/tools/caffe train -solver examples/finetuning_on_flickr_style/solver.prototxt -weights models/bvlc_reference_caffenet/bvlc_reference_caffenet.caffemodel</div></div><div><br/></div><div>-iterations：可选参数。迭代次数，默认为50。如果在配置文件中没有设定迭代次数，则默认迭代50次。</div><div><br/></div><div>-model：可选参数，定义在protocol buffer文件中的模型。也可以在solver配置文件中指定。</div><div><br/></div><div>-sighup_effect：可选参数。用来设定当程序发生挂起事件时，执行的操作，可以设置为snapshot，stop或none。默认为snapshot。</div><div><br/></div><div>-sigint_effect：可选参数。用来设定当程序发生键盘中止事件时(Ctrl+C)，执行的操作，可以设置为snapshot，stop或none。默认为stop。</div><div><br/></div><div>刚才列举了一些train参数的例子，现在我们来看看其他三个&lt;command&gt;：</div><div><br/></div><div><b>test</b>参数用在测试阶段，用于最终结果的输出，模型配置文件中我们可以设定需要输出accuracy还是loss。假设我们要在验证集中验证已经训练好的模型，就可以这样写：</div><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div># ./build/tools/caffe test -model example/mnist/lenet_train_test.prototxt -weights examples/mnist/lenet_iter_10000.caffemodel -gpu 0 -iterations 100</div></div><div><br/></div><div>这个例子比较长，不仅用到了test参数，还用到了-model、-weights、-gpu和-iterations四个参数。意思是利用训练好了的权重(-weights)，输入到测试模型中(-model)，用编号为0的GPU(-gpu)测试100次(-iterations)。</div><div><br/></div><div><b>time</b>参数用来在屏幕上显示程序的运行时间。如：</div><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div># ./build/tools/caffe time -model examples/mnist/lenet_train_test.prototxt -iterations 10</div></div><div><br/></div><div>这个例子用来在屏幕上显示lenet模型迭代10次所使用的时间。包括每次迭代的forward和backward所用的时间，也包括每层forward和backward所用的平均时间。</div><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div># ./build/tools/caffe time -model examples/mnist/lenet_train_test.prototxt -gpu 0</div></div><div><br/></div><div>这个例子用来在屏幕上显示lenet模型用GPU迭代50次所使用的时间。</div><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div># ./build/tools/caffe time -model examples/mnist/lenet_train_test.prototxt -weights examples/mnist/lenet_iter_10000.caffemodel -gpu 0 -iterations 10</div></div><div><br/></div><div>利用给定的权重(-weights)，利用第一块GPU(-gpu)，迭代10次(-iterations)lenet模型所用的时间。</div><div><br/></div><div><b>device_query</b>参数用来诊断GPU信息。</div><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div># ./build/tools/caffe device_query -gpu 0</div></div><div><br/></div><div>最后，我们来看两个关于GPU的例子：</div><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div># ./build/tools/caffe train -solver examples/mnist/lenet_solver.prototxt -gpu 0,1</div></div><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div># ./build/tools/caffe train -solver exmaples/mnist/lenet_solver.prototxt -gpu all</div></div><div><br/></div><div>这两个例子表示：用两块或多块GPU来并行计算，这样速度会快很多。但是如果你只有一块或没有GPU，就不要加-gpu参数了，加了反而慢。</div><div><br/></div><div>最后，在linux下，本身就有一个time命令，因此可以结合进来使用：</div><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div># sudo time ./build/tools/caffe train -solver examples/mnist/lenet_solver.prototxt</div></div><div><br/></div><div><br/></div><div><br/></div></span>
</div></body></html> 